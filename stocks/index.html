<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buffett Network Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; }
        
        /* UI CONTROL PANEL */
        #controls {
            position: absolute;
            top: 20px; left: 20px;
            background: rgba(30,30,30,0.9);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #444;
            z-index: 100;
        }
        select { background: #222; color: #0f0; border: 1px solid #0f0; padding: 5px; margin-top: 5px; }
        .legend { font-size: 12px; color: #ccc; margin-top: 10px; }
        
        /* GRAPH STYLES */
        .link { stroke: #333; stroke-opacity: 0.6; }
        .node { stroke: #fff; stroke-width: 1.5px; cursor: pointer; }
        text { font-size: 10px; fill: #eee; pointer-events: none; }
        
        /* TOOLTIP */
        #tooltip {
            position: absolute; visibility: hidden;
            background: rgba(0,0,0,0.9); border: 1px solid #fff;
            padding: 10px; border-radius: 5px; font-size: 12px; pointer-events: none;
        }
        
        /* BACK BUTTON */
        .back { position: absolute; bottom: 20px; left: 20px; color: #666; text-decoration: none; }
        .back:hover { color: #fff; }
    </style>
</head>
<body>

<div id="controls">
    <h3>Buffett Market Network</h3>
    <label>Color By Metric:</label><br>
    <select id="metricSelect">
        <option value="score">Aggregate Score (0-5)</option>
        <option value="grossMargin">Gross Margin (>40%)</option>
        <option value="debtToEquity">Debt/Equity (<0.5)</option>
        <option value="sgaRatio">SG&A Efficiency (<30%)</option>
    </select>
    <div class="legend">
        Lines connect stocks with<br>similar price movement.
    </div>
</div>

<div id="tooltip"></div>
<a href="/" class="back">‚Üê Exit to Cockpit</a>

<script>
    const width = window.innerWidth, height = window.innerHeight;

    // Zoomable Canvas
    const svg = d3.select("body").append("svg")
        .attr("width", width).attr("height", height)
        .call(d3.zoom().on("zoom", (event) => g.attr("transform", event.transform)))
        .append("g");
    
    const g = svg.append("g");

    d3.json("data.json").then(graph => {
        
        // SCALES
        const sizeScale = d3.scaleSqrt()
            .domain([0, 3000000000000])
            .range([5, 30]); // Smaller nodes for network look

        // FORCE SIMULATION
        const simulation = d3.forceSimulation(graph.nodes)
            .force("link", d3.forceLink(graph.links).id(d => d.id).distance(100)) // Connect correlated stocks
            .force("charge", d3.forceManyBody().strength(-300)) // Repel each other
            .force("center", d3.forceCenter(width / 2, height / 2));

        // DRAW LINKS (The Web)
        const link = g.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(graph.links)
            .enter().append("line")
            .attr("class", "link")
            .attr("stroke-width", d => d.value * 2); // Thicker line = higher correlation

        // DRAW NODES (The Stocks)
        const node = g.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(graph.nodes)
            .enter().append("circle")
            .attr("class", "node")
            .attr("r", d => sizeScale(d.marketCap))
            .attr("fill", d => getColor(d, "score"))
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        // LABELS
        const labels = g.append("g")
            .selectAll("text")
            .data(graph.nodes)
            .enter().append("text")
            .text(d => d.id)
            .attr("dx", 12)
            .attr("dy", ".35em");

        // UPDATE LOOP
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            labels
                .attr("x", d => d.x)
                .attr("y", d => d.y);
        });

        // --- INTERACTIVITY ---
        
        // 1. Tooltip
        const tooltip = d3.select("#tooltip");
        node.on("mouseover", (e, d) => {
            tooltip.style("visibility", "visible")
                .html(`<strong>${d.id}</strong><br>
                       Score: ${d.buffettScore}/5<br>
                       Margin: ${(d.metrics.grossMargin*100).toFixed(0)}%<br>
                       Debt/Eq: ${d.metrics.debtToEquity}`);
        }).on("mousemove", (e) => {
            tooltip.style("top", (e.pageY+10)+"px").style("left", (e.pageX+10)+"px");
        }).on("mouseout", () => tooltip.style("visibility", "hidden"));

        // 2. Filter / Color Change Logic
        d3.select("#metricSelect").on("change", function() {
            const metric = this.value;
            node.transition().duration(500).attr("fill", d => getColor(d, metric));
        });

        function getColor(d, metric) {
            // Aggregate Score Color (Red to Green)
            if (metric === "score") {
                if (d.buffettScore >= 4) return "#00ff41"; // Green
                if (d.buffettScore >= 2) return "#ffcc00"; // Yellow
                return "#ff3333"; // Red
            }
            // Gross Margin Logic
            if (metric === "grossMargin") {
                return d.metrics.grossMargin > 0.4 ? "#00ff41" : "#555";
            }
            // Debt Logic
            if (metric === "debtToEquity") {
                return d.metrics.debtToEquity < 0.5 ? "#00ff41" : "#555";
            }
            return "#aaa";
        }

        // DRAG FUNCTIONS
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x; d.fy = d.y;
        }
        function dragged(event, d) {
            d.fx = event.x; d.fy = event.y;
        }
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null; d.fy = null;
        }
    });
</script>
</body>
</html>
