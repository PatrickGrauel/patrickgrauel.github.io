name: üöÄ Complete Update Pipeline

on:
  # Run daily at 6 PM UTC (after US market close)
  schedule:
    - cron: '0 18 * * *'
  
  # Allow manual trigger with options
  workflow_dispatch:
    inputs:
      stock_count:
        description: 'Number of stocks to analyze'
        required: false
        default: '60'
        type: choice
        options:
          - '20'
          - '60'
          - '100'

jobs:
  complete-update:
    runs-on: ubuntu-latest
    
    steps:
      # ============================================
      # STEP 1: Setup Environment
      # ============================================
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üêç Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # ============================================
      # STEP 2: Install Dependencies
      # ============================================
      - name: üì¶ Install Python dependencies
        run: |
          echo "Installing dependencies..."
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
          echo "‚úÖ Dependencies installed"
      
      # ============================================
      # STEP 3: Test Yahoo Finance Connection
      # ============================================
      - name: üîç Test Yahoo Finance API access
        id: test_api
        run: |
          echo "Testing Yahoo Finance connection..."
          python -c "
          import yfinance as yf
          try:
              stock = yf.Ticker('AAPL')
              info = stock.info
              market_cap = info.get('marketCap', 0)
              if market_cap > 0:
                  print(f'‚úÖ Connection successful! AAPL Market Cap: \${market_cap/1e9:.1f}B')
                  exit(0)
              else:
                  print('‚ö†Ô∏è Connection established but data incomplete')
                  exit(1)
          except Exception as e:
              print(f'‚ùå Connection failed: {str(e)[:100]}')
              exit(1)
          "
        continue-on-error: true
      
      # ============================================
      # STEP 4: Fetch Real Yahoo Finance Data
      # ============================================
      - name: üìä Fetch stock data from Yahoo Finance
        id: fetch_data
        run: |
          echo "========================================"
          echo "Starting data fetch process..."
          echo "Target stocks: ${{ github.event.inputs.stock_count || '60' }}"
          echo "========================================"
          
          python fetch_real_data.py
          
          echo "========================================"
          echo "Data fetch completed!"
          echo "========================================"
        env:
          STOCK_COUNT: ${{ github.event.inputs.stock_count || '60' }}
        continue-on-error: false
      
      # ============================================
      # STEP 5: Verify Data Quality
      # ============================================
      - name: ‚úÖ Verify data was generated correctly
        id: verify_data
        run: |
          echo "Verifying generated data..."
          
          if [ ! -f data/graph_data.json ]; then
            echo "‚ùå ERROR: data/graph_data.json not found!"
            exit 1
          fi
          
          # Check file size
          file_size=$(stat -f%z data/graph_data.json 2>/dev/null || stat -c%s data/graph_data.json 2>/dev/null)
          echo "File size: $(echo $file_size | awk '{printf "%.1f KB", $1/1024}')"
          
          if [ "$file_size" -lt 1000 ]; then
            echo "‚ö†Ô∏è WARNING: File is very small (< 1KB), might be empty"
          fi
          
          # Count stocks
          stock_count=$(grep -o '"id"' data/graph_data.json | wc -l | tr -d ' ')
          echo "Stocks in file: $stock_count"
          
          if [ "$stock_count" -eq 0 ]; then
            echo "‚ùå ERROR: No stocks in data file!"
            echo "The fetch probably failed. Check logs above."
            exit 1
          fi
          
          # Count links
          link_count=$(grep -o '"source"' data/graph_data.json | wc -l | tr -d ' ')
          echo "Correlations found: $link_count"
          
          # Show sample data
          echo ""
          echo "Sample of generated data:"
          head -20 data/graph_data.json
          
          echo ""
          echo "‚úÖ Data verification passed!"
          echo "   - Stocks: $stock_count"
          echo "   - Links: $link_count"
          echo "   - Size: $(echo $file_size | awk '{printf "%.1f KB", $1/1024}')"
      
      # ============================================
      # STEP 6: Commit Changes
      # ============================================
      - name: üíæ Commit and push updated data
        id: commit_data
        run: |
          echo "Preparing to commit changes..."
          
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "action@github.com"
          
          # Add the data file
          git add data/graph_data.json
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit (data is identical)"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            # Get stock count for commit message
            stock_count=$(grep -o '"id"' data/graph_data.json | wc -l | tr -d ' ')
            
            # Commit with detailed message
            commit_msg="ü§ñ Auto-update: $stock_count stocks analyzed ($(date +'%Y-%m-%d %H:%M UTC'))"
            git commit -m "$commit_msg"
            
            echo "Pushing changes..."
            git push
            
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes committed and pushed!"
            echo "   Commit: $commit_msg"
          fi
      
      # ============================================
      # STEP 7: Create Summary
      # ============================================
      - name: üìã Generate workflow summary
        if: always()
        run: |
          echo "# üìä Buffett Focus Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if data file exists
          if [ -f data/graph_data.json ]; then
            stock_count=$(grep -o '"id"' data/graph_data.json | wc -l | tr -d ' ')
            link_count=$(grep -o '"source"' data/graph_data.json | wc -l | tr -d ' ')
            file_size=$(stat -f%z data/graph_data.json 2>/dev/null || stat -c%s data/graph_data.json 2>/dev/null)
            
            echo "## ‚úÖ Success!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Stocks Analyzed | $stock_count |" >> $GITHUB_STEP_SUMMARY
            echo "| Correlations Found | $link_count |" >> $GITHUB_STEP_SUMMARY
            echo "| File Size | $(echo $file_size | awk '{printf "%.1f KB", $1/1024}') |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üéâ Your visualization has been updated with fresh data!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Data file was not generated. Check the logs above for errors." >> $GITHUB_STEP_SUMMARY
          fi
      
      # ============================================
      # STEP 8: Notify on Failure (Optional)
      # ============================================
      - name: üö® Workflow failed - check logs
        if: failure()
        run: |
          echo "================================"
          echo "‚ùå WORKFLOW FAILED"
          echo "================================"
          echo ""
          echo "Common issues:"
          echo "1. Yahoo Finance API is down or blocking requests"
          echo "2. Network connectivity problems"
          echo "3. Invalid ticker symbols"
          echo "4. Permission issues (check Settings ‚Üí Actions)"
          echo ""
          echo "Check the step logs above for specific error messages."
          echo "================================"
          exit 1
